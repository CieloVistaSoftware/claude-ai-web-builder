/**
 * MCP API Test Script
 * 
 * This script tests the MCP API by:
 * 1. Making a request to the MCP generate endpoint
 * 2. Saving the generated files to disk
 * 3. Validating the HTML output
 * 
 * No PS1 files are used, following project guidelines
 */

const fs = require('fs');
const path = require('path');
const http = require('http');
const { JSDOM } = require('jsdom');
const chalk = require('chalk'); // For colorful console output

// Configuration
const API_HOST = 'localhost';
const API_PORT = 8000;
const API_PATH = '/mcp/generate';
const OUTPUT_DIR = path.join(__dirname, '..', 'mcp-test-output');

// Create output directory if it doesn't exist
if (!fs.existsSync(OUTPUT_DIR)) {
  fs.mkdirSync(OUTPUT_DIR, { recursive: true });
  console.log(chalk.blue(`Created output directory: ${OUTPUT_DIR}`));
}

// Prepare test payload (correctly formatted for the MCP API)
const payload = {
  toolName: "claude-ai-website-builder",
  website: {
    type: "portfolio",
    features: ["table-theme", "theme-generator", "responsive-design"]
  },
  content: {
    title: "MCP Test Portfolio",
    description: "A test portfolio generated by the MCP API"
  },
  output: {
    format: "files"
  },
  customization: {
    primaryColor: "#3b82f6",
    secondaryColor: "#f8fafc",
    accentColor: "#10b981"
  }
};

console.log(chalk.cyan('ğŸš€ Starting MCP API Test'));
console.log(chalk.gray('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'));

// Function to validate HTML
function validateHtml(html) {
  try {
    const dom = new JSDOM(html);
    const document = dom.window.document;
    
    console.log(chalk.green('âœ… HTML parsed successfully'));
    
    // Basic validation checks
    const htmlElement = document.querySelector('html');
    const headElement = document.querySelector('head');
    const bodyElement = document.querySelector('body');
    const titleElement = document.querySelector('title');
    
    if (!htmlElement) console.log(chalk.red('âŒ Missing <html> element'));
    if (!headElement) console.log(chalk.red('âŒ Missing <head> element'));
    if (!bodyElement) console.log(chalk.red('âŒ Missing <body> element'));
    if (!titleElement) console.log(chalk.red('âŒ Missing <title> element'));
    else console.log(chalk.green(`âœ… Title: ${titleElement.textContent}`));
    
    // Check for required elements
    const scripts = document.querySelectorAll('script');
    const styles = document.querySelectorAll('style');
    const links = document.querySelectorAll('link');
    
    console.log(chalk.green(`âœ… Found ${scripts.length} script elements`));
    console.log(chalk.green(`âœ… Found ${styles.length} style elements`));
    console.log(chalk.green(`âœ… Found ${links.length} link elements`));
    
    return true;
  } catch (error) {
    console.log(chalk.red(`âŒ HTML validation failed: ${error.message}`));
    return false;
  }
}

// Make the API request
console.log(chalk.blue('ğŸ“¡ Sending request to MCP API...'));

const postData = JSON.stringify(payload);

const options = {
  hostname: API_HOST,
  port: API_PORT,
  path: API_PATH,
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Content-Length': Buffer.byteLength(postData)
  }
};

const req = http.request(options, (res) => {
  console.log(chalk.blue(`ğŸ“¡ Response status: ${res.statusCode}`));
  
  let data = '';
  
  res.on('data', (chunk) => {
    data += chunk;
  });
  
  res.on('end', () => {
    try {
      // Parse the JSON response
      const response = JSON.parse(data);
      
      if (!response.success) {
        console.log(chalk.red(`âŒ API returned error: ${response.error || 'Unknown error'}`));
        process.exit(1);
      }
      
      console.log(chalk.green(`âœ… API request successful!`));
      console.log(chalk.blue(`ğŸ“¦ Generated ${response.files.length} files`));
      
      // Save each generated file
      let savedFiles = 0;
      const savedFilePaths = [];
      
      response.files.forEach(file => {
        // Create directories for the file path
        const filePath = path.join(OUTPUT_DIR, file.path);
        const fileDir = path.dirname(filePath);
        
        if (!fs.existsSync(fileDir)) {
          fs.mkdirSync(fileDir, { recursive: true });
        }
        
        // Write the file content
        fs.writeFileSync(filePath, file.content);
        savedFiles++;
        savedFilePaths.push(filePath);
        
        console.log(chalk.green(`âœ… Saved: ${file.path} (${file.content.length} bytes)`));
      });
      
      console.log(chalk.blue(`ğŸ“¦ Saved ${savedFiles} files to ${OUTPUT_DIR}`));
      console.log(chalk.gray('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'));
      
      // Validate the main HTML file
      const indexHtmlPath = path.join(OUTPUT_DIR, 'index.html');
      if (fs.existsSync(indexHtmlPath)) {
        console.log(chalk.blue('ğŸ” Validating index.html...'));
        
        const indexHtml = fs.readFileSync(indexHtmlPath, 'utf8');
        validateHtml(indexHtml);
        
        console.log(chalk.green('âœ… HTML validation complete'));
      } else {
        console.log(chalk.red('âŒ index.html not found in generated files'));
      }
      
      // Write a summary file with metadata
      const summaryPath = path.join(OUTPUT_DIR, 'test-summary.json');
      fs.writeFileSync(summaryPath, JSON.stringify({
        testDate: new Date().toISOString(),
        testSuccess: true,
        generatedFiles: savedFilePaths,
        metadata: response.metadata,
        recommendations: response.recommendations || []
      }, null, 2));
      
      console.log(chalk.gray('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'));
      console.log(chalk.green('âœ… Test completed successfully!'));
      console.log(chalk.blue(`ğŸ“ Summary saved to: ${path.relative(process.cwd(), summaryPath)}`));
      console.log(chalk.blue(`ğŸŒ To view the generated site, open: ${path.relative(process.cwd(), indexHtmlPath)}`));
      
    } catch (error) {
      console.log(chalk.red(`âŒ Error processing API response: ${error.message}`));
      console.log(chalk.gray('Raw response:'));
      console.log(data);
      process.exit(1);
    }
  });
});

req.on('error', (error) => {
  console.log(chalk.red(`âŒ API request failed: ${error.message}`));
  process.exit(1);
});

// Send the request
req.write(postData);
req.end();
