/**
 * build-manifest.js - Automatically generate component manifest
 * 
 * Scans the components directory and builds manifest.json
 * Run: node scripts/build-manifest.js
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// Get __dirname equivalent in ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Configuration
const config = {
    rootDir: path.join(__dirname, '..'),
    componentsDir: path.join(__dirname, '..', 'components'),
    utilsDir: path.join(__dirname, '..', 'utils', 'wb'),
    stylesDir: path.join(__dirname, '..', 'styles'),
    outputFile: path.join(__dirname, '..', 'components', 'manifest.json')
};

console.log('üîç Scanning for components...');

// Scan utils directory for infrastructure files
function scanInfrastructure() {
    const files = [];
    if (fs.existsSync(config.utilsDir)) {
        const entries = fs.readdirSync(config.utilsDir);
        entries.forEach(file => {
            if (file.endsWith('.js') && !file.includes('.test.')) {
                files.push(file);
            }
        });
    }
    return files.sort();
}

// Scan styles directory
function scanStyles() {
    const files = [];
    if (fs.existsSync(config.stylesDir)) {
        const entries = fs.readdirSync(config.stylesDir);
        entries.forEach(file => {
            if (file.endsWith('.js') && !file.includes('.test.')) {
                files.push(file);
            }
        });
    }
    return files.sort();
}

// Scan components directory
function scanComponents() {
    const components = [];
    
    if (!fs.existsSync(config.componentsDir)) {
        console.warn('‚ö†Ô∏è Components directory not found');
        return components;
    }
    
    const entries = fs.readdirSync(config.componentsDir);
    
    entries.forEach(entry => {
        const entryPath = path.join(config.componentsDir, entry);
        const stat = fs.statSync(entryPath);
        
        // Check if it's a directory and starts with 'wb-'
        if (stat.isDirectory() && entry.startsWith('wb-')) {
            // Check if component.js exists
            const componentFile = path.join(entryPath, `${entry}.js`);
            if (fs.existsSync(componentFile)) {
                components.push(entry);
            }
        }
    });
    
    return components.sort();
}

// Read component metadata to determine dependencies
function analyzeComponentDependencies(componentName) {
    const componentFile = path.join(config.componentsDir, componentName, `${componentName}.js`);
    
    try {
        const content = fs.readFileSync(componentFile, 'utf8');
        
        // Look for dependency declarations (example patterns)
        // const dependencies = ['wb-toggle', 'wb-select'];
        // window.WBComponentRegistry.register('wb-name', Class, ['dep1', 'dep2']);
        
        const depMatch = content.match(/dependencies\s*=\s*\[([^\]]+)\]/);
        if (depMatch) {
            const deps = depMatch[1]
                .split(',')
                .map(d => d.trim().replace(/['"]/g, ''))
                .filter(d => d.startsWith('wb-'));
            return deps;
        }
    } catch (error) {
        console.warn(`‚ö†Ô∏è Could not analyze ${componentName}:`, error.message);
    }
    
    return [];
}

// Categorize components into dependencies and main components
function categorizeComponents(components) {
    const dependencies = [];
    const mainComponents = [];
    
    // Known dependencies (commonly used by other components)
    const knownDeps = ['wb-toggle', 'wb-select', 'wb-button', 'wb-input', 
                       'wb-color-bar', 'wb-color-bars', 'wb-slider'];
    
    components.forEach(component => {
        const deps = analyzeComponentDependencies(component);
        
        // If it's used by others or is a known dep, it's a dependency
        if (knownDeps.includes(component) || deps.length > 0) {
            dependencies.push(component);
        } else {
            mainComponents.push(component);
        }
    });
    
    return { dependencies, mainComponents };
}

// Build the manifest
function buildManifest() {
    console.log('üì¶ Building manifest...');
    
    const infrastructure = scanInfrastructure();
    console.log(`   Found ${infrastructure.length} infrastructure files`);
    
    const styles = scanStyles();
    console.log(`   Found ${styles.length} style files`);
    
    const allComponents = scanComponents();
    console.log(`   Found ${allComponents.length} components`);
    
    const { dependencies, mainComponents } = categorizeComponents(allComponents);
    console.log(`   - ${dependencies.length} dependencies`);
    console.log(`   - ${mainComponents.length} main components`);
    
    const manifest = {
        "$schema": "./manifest.schema.json",
        "version": "1.0.0",
        "description": "WB Component Manifest - Auto-generated by build-manifest.js",
        "generated": new Date().toISOString(),
        
        "infrastructure": infrastructure,
        "styles": styles,
        "dependencies": dependencies,
        "components": mainComponents,
        
        "metadata": {
            "totalComponents": allComponents.length,
            "lastUpdated": new Date().toISOString(),
            "buildScript": "scripts/build-manifest.js",
            "notes": "This file is auto-generated. Run 'npm run build:manifest' to regenerate."
        }
    };
    
    return manifest;
}

// Write manifest to file
function writeManifest(manifest) {
    const jsonContent = JSON.stringify(manifest, null, 2);
    fs.writeFileSync(config.outputFile, jsonContent, 'utf8');
    console.log(`‚úÖ Manifest written to: ${config.outputFile}`);
    console.log('');
    console.log('üìã Summary:');
    console.log(`   Infrastructure: ${manifest.infrastructure.length} files`);
    console.log(`   Styles: ${manifest.styles.length} files`);
    console.log(`   Dependencies: ${manifest.dependencies.length} components`);
    console.log(`   Main Components: ${manifest.components.length} components`);
    console.log(`   Total Scripts: ${manifest.infrastructure.length + manifest.styles.length + manifest.dependencies.length + manifest.components.length}`);
}

// Main execution
try {
    const manifest = buildManifest();
    writeManifest(manifest);
    console.log('‚úÖ Build complete!');
} catch (error) {
    console.error('‚ùå Build failed:', error);
    process.exit(1);
}
