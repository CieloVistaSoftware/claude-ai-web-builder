<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Component Diagnosis</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        body {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 30px;
            text-align: center;
        }
        wb-event-log {
            display: block;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üîç Component Diagnosis & Testing</h1>
    
    <!-- WB Event Log - Shows all diagnostic messages -->
    <wb-event-log></wb-event-log>

    <!-- Load main.js which includes WBEventLog utilities -->
    <script src="styles/main.js"></script>
    
    <!-- Load wb-event-log component -->
    <script src="components/wb-event-log/wb-event-log.js"></script>
    
    <script>
        // Wait for WBEventLog to be ready
        function waitForEventLog() {
            return new Promise(resolve => {
                if (window.WBEventLog || document.querySelector('wb-event-log')) {
                    resolve();
                } else {
                    setTimeout(() => waitForEventLog().then(resolve), 50);
                }
            });
        }

        // Load script helper
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    if (window.WBEventLog) {
                        WBEventLog.logSuccess(`Script loaded: ${src}`, { component: 'diagnosis', src });
                    }
                    resolve();
                };
                script.onerror = () => {
                    if (window.WBEventLog) {
                        WBEventLog.logError(`Script failed: ${src}`, { component: 'diagnosis', src });
                    }
                    reject(new Error(`Failed to load ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        async function diagnoseComponents() {
            await waitForSafeLogger();
            
            document.dispatchEvent(new CustomEvent('wb:info', { detail: { message: 'Starting component diagnosis...', component: 'diagnosis' } }));

            // Wait for wb-event-log to be ready
            await new Promise(resolve => {
                const check = () => {
                    if (customElements.get('wb-event-log')) resolve();
                    else setTimeout(check, 100);
                };
                check();
            });
            document.dispatchEvent(new CustomEvent('wb:success', { detail: { message: 'wb-event-log ready', component: 'diagnosis' } }));

            // Wait for main.js to be ready
            if (!window.WBMainJS?.ready) {
                document.dispatchEvent(new CustomEvent('wb:warning', { detail: { message: 'Waiting for WBMainJS...', component: 'diagnosis' } }));
                await new Promise(resolve => {
                    const check = () => {
                        if (window.WBMainJS?.ready) resolve();
                        else setTimeout(check, 100);
                    };
                    check();
                });
            }
            document.dispatchEvent(new CustomEvent('wb:success', { detail: { message: 'WBMainJS ready', component: 'diagnosis' } }));

            // Test 1: WBComponentUtils (already loaded by main.js)
            if (window.WBComponentUtils) {
                document.dispatchEvent(new CustomEvent('wb:success', { detail: { message: 'WBComponentUtils available', component: 'diagnosis' } }));
            } else {
                document.dispatchEvent(new CustomEvent('wb:warning', { detail: { message: 'WBComponentUtils not available', component: 'diagnosis' } }));
            }

            // Test 2: WBComponentRegistry (already loaded by main.js)
            if (window.WBComponentRegistry) {
                document.dispatchEvent(new CustomEvent('wb:success', { detail: { message: 'WBComponentRegistry available', component: 'diagnosis' } }));
            } else {
                document.dispatchEvent(new CustomEvent('wb:warning', { detail: { message: 'WBComponentRegistry not available', component: 'diagnosis' } }));
            }

            // Test 3: wb-color-bar
            try {
                await loadScript('components/wb-color-bar/wb-color-bar.js');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (customElements.get('wb-color-bar')) {
                    document.dispatchEvent(new CustomEvent('wb:success', { detail: { message: 'wb-color-bar registered', component: 'diagnosis' } }));
                } else {
                    document.dispatchEvent(new CustomEvent('wb:error', { detail: { message: 'wb-color-bar not registered', component: 'diagnosis' } }));
                }
            } catch (error) {
                document.dispatchEvent(new CustomEvent('wb:error', { detail: { message: 'wb-color-bar failed', component: 'diagnosis', error: error.message } }));
            }

            // Test 4: wb-color-bars
            try {
                await loadScript('components/wb-color-bars/wb-color-bars.js');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (customElements.get('wb-color-bars')) {
                    document.dispatchEvent(new CustomEvent('wb:success', { detail: { message: 'wb-color-bars registered', component: 'diagnosis' } }));
                } else {
                    document.dispatchEvent(new CustomEvent('wb:error', { detail: { message: 'wb-color-bars not registered', component: 'diagnosis' } }));
                }
            } catch (error) {
                document.dispatchEvent(new CustomEvent('wb:error', { detail: { message: 'wb-color-bars failed', component: 'diagnosis', error: error.message } }));
            }

            // Test 5: wb-nav
            try {
                await loadScript('components/wb-nav/wb-nav.js');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (customElements.get('wb-nav')) {
                    document.dispatchEvent(new CustomEvent('wb:success', { detail: { message: 'wb-nav registered', component: 'diagnosis' } }));
                } else {
                    document.dispatchEvent(new CustomEvent('wb:error', { detail: { message: 'wb-nav not registered', component: 'diagnosis' } }));
                }
            } catch (error) {
                document.dispatchEvent(new CustomEvent('wb:error', { detail: { message: 'wb-nav failed', component: 'diagnosis', error: error.message } }));
            }

            // Test 6: wb-control-panel
            try {
                await loadScript('components/wb-control-panel/wb-control-panel.js');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (customElements.get('wb-control-panel')) {
                    document.dispatchEvent(new CustomEvent('wb:success', { detail: { message: 'wb-control-panel registered', component: 'diagnosis' } }));
                } else {
                    document.dispatchEvent(new CustomEvent('wb:error', { detail: { message: 'wb-control-panel not registered', component: 'diagnosis' } }));
                }
            } catch (error) {
                document.dispatchEvent(new CustomEvent('wb:error', { detail: { message: 'wb-control-panel failed', component: 'diagnosis', error: error.message } }));
            }

            document.dispatchEvent(new CustomEvent('wb:success', { detail: { message: 'Diagnosis complete!', component: 'diagnosis' } }));
        }

        // Capture global errors
        window.addEventListener('error', (event) => {
            document.dispatchEvent(new CustomEvent('wb:error', { 
                detail: { 
                    message: `Global error: ${event.message}`,
                    component: 'diagnosis',
                    filename: event.filename,
                    lineno: event.lineno,
                    error: event.error?.message
                }
            }));
            event.preventDefault();
        });

        window.addEventListener('unhandledrejection', (event) => {
            document.dispatchEvent(new CustomEvent('wb:error', { 
                detail: { 
                    message: `Unhandled rejection: ${event.reason}`,
                    component: 'diagnosis',
                    reason: event.reason 
                }
            }));
            event.preventDefault();
        });

        // Start diagnosis when DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                diagnoseComponents().catch(error => {
                    document.dispatchEvent(new CustomEvent('wb:error', { 
                        detail: { 
                            message: `Diagnosis crashed: ${error.message}`,
                            component: 'diagnosis',
                            error: error.message 
                        }
                    }));
                });
            });
        } else {
            diagnoseComponents().catch(error => {
                document.dispatchEvent(new CustomEvent('wb:error', { 
                    detail: { 
                        message: `Diagnosis crashed: ${error.message}`,
                        component: 'diagnosis',
                        error: error.message 
                    }
                }));
            });
        }
    </script>
</body>
</html>

        // Load script helper (non-module approach)
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    log(`‚úÖ Script loaded: ${src}`, 'success');
                    resolve();
                };
                script.onerror = () => {
                    log(`‚ùå Script failed: ${src}`, 'error');
                    reject(new Error(`Failed to load ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        async function diagnoseComponents() {
            log('üîç Starting component diagnosis...', 'info');

            // Wait for main.js to be ready
            if (!window.WBMainJS?.ready) {
                log('‚è≥ Waiting for WBMainJS to be ready...', 'warning');
                await new Promise(resolve => {
                    const checkReady = () => {
                        if (window.WBMainJS?.ready) {
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });
            }
            log('‚úÖ WBMainJS ready', 'success');

            // Test 1: Check WBEventLog
            if (window.WBEventLog) {
                log('‚úÖ WBEventLog available', 'success');
            } else {
                log('‚ö†Ô∏è WBEventLog not available (creating fallback)', 'warning');
            }

            // Test 2: Check WBComponentRegistry
            try {
                await loadScript('utils/wb/wb-component-registry.js');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (window.WBComponentRegistry) {
                    log('‚úÖ WBComponentRegistry loaded successfully', 'success');
                } else {
                    log('‚ùå WBComponentRegistry not available on window', 'error');
                }
            } catch (error) {
                log(`‚ùå WBComponentRegistry failed: ${error.message}`, 'error');
            }

            // Test 3: Check WBComponentUtils
            try {
                await loadScript('utils/wb/wb-component-utils.js');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (window.WBComponentUtils) {
                    log('‚úÖ WBComponentUtils loaded successfully', 'success');
                } else {
                    log('‚ùå WBComponentUtils not available', 'error');
                }
            } catch (error) {
                log(`‚ùå WBComponentUtils failed: ${error.message}`, 'error');
            }

            // Test 4: Try loading wb-color-bar
            try {
                await loadScript('components/wb-color-bar/wb-color-bar.js');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (customElements.get('wb-color-bar')) {
                    log('‚úÖ wb-color-bar registered', 'success');
                    
                    // Try creating an instance
                    const colorBar = document.createElement('wb-color-bar');
                    colorBar.setAttribute('type', 'hue');
                    colorBar.setAttribute('value', '180');
                    componentTests.appendChild(colorBar);
                    log('‚úÖ wb-color-bar instance created', 'success');
                } else {
                    log('‚ùå wb-color-bar not registered', 'error');
                }
            } catch (error) {
                log(`‚ùå wb-color-bar failed: ${error.message}`, 'error');
            }

            // Test 5: Try loading wb-color-bars
            try {
                await loadScript('components/wb-color-bars/wb-color-bars.js');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (customElements.get('wb-color-bars')) {
                    log('‚úÖ wb-color-bars registered', 'success');
                    
                    // Try creating an instance
                    const colorBars = document.createElement('wb-color-bars');
                    colorBars.setAttribute('text-hue', '240');
                    colorBars.setAttribute('text-saturation', '70');
                    colorBars.setAttribute('text-lightness', '90');
                    componentTests.appendChild(colorBars);
                    log('‚úÖ wb-color-bars instance created', 'success');
                } else {
                    log('‚ùå wb-color-bars not registered', 'error');
                }
            } catch (error) {
                log(`‚ùå wb-color-bars failed: ${error.message}`, 'error');
            }

            // Test 6: Try loading wb-nav
            try {
                await loadScript('components/wb-nav/wb-nav.js');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (customElements.get('wb-nav')) {
                    log('‚úÖ wb-nav registered', 'success');
                    
                    // Try creating an instance
                    const nav = document.createElement('wb-nav');
                    const navItems = [
                        { text: 'Home', href: '#home' },
                        { text: 'About', href: '#about' },
                        { text: 'Contact', href: '#contact' }
                    ];
                    nav.setAttribute('items', JSON.stringify(navItems));
                    componentTests.appendChild(nav);
                    log('‚úÖ wb-nav instance created', 'success');
                } else {
                    log('‚ùå wb-nav not registered', 'error');
                }
            } catch (error) {
                log(`‚ùå wb-nav failed: ${error.message}`, 'error');
            }

            // Test 7: Try loading wb-control-panel
            try {
                await loadScript('components/wb-control-panel/wb-control-panel.js');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (customElements.get('wb-control-panel')) {
                    log('‚úÖ wb-control-panel registered', 'success');
                    
                    // Try creating an instance
                    const controlPanel = document.createElement('wb-control-panel');
                    componentTests.appendChild(controlPanel);
                    log('‚úÖ wb-control-panel instance created', 'success');
                } else {
                    log('‚ùå wb-control-panel not registered', 'error');
                }
            } catch (error) {
                log(`‚ùå wb-control-panel failed: ${error.message}`, 'error');
            }

            // Test 8: Check for any errors in created components
            await new Promise(resolve => setTimeout(resolve, 2000));
            const components = componentTests.querySelectorAll('*');
            log(`üß™ Created ${components.length} component instances`, 'info');
            
            components.forEach((comp, idx) => {
                const hasContent = comp.shadowRoot?.innerHTML?.length > 0 || comp.innerHTML?.length > 0;
                if (hasContent) {
                    log(`  ‚úÖ Component ${idx + 1} (${comp.tagName.toLowerCase()}) has content`, 'success');
                } else {
                    log(`  ‚ö†Ô∏è Component ${idx + 1} (${comp.tagName.toLowerCase()}) appears empty`, 'warning');
                }
            });

            log('üèÅ Diagnosis complete!', 'success');
        }

        // Capture global errors
        window.addEventListener('error', (event) => {
            log(`üö® Global error: ${event.message} in ${event.filename}:${event.lineno}`, 'error');
            event.preventDefault();
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`üö® Unhandled rejection: ${event.reason}`, 'error');
            event.preventDefault();
        });

        // Wait for DOM to be ready, then start diagnosis
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                diagnoseComponents().catch(error => {
                    log(`üí• Diagnosis crashed: ${error.message}`, 'error');
                });
            });
        } else {
            diagnoseComponents().catch(error => {
                log(`üí• Diagnosis crashed: ${error.message}`, 'error');
            });
        }
    </script>
</body>
</html>